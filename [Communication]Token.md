# Token

> 어떤 리소스를 얻기 위해서는 사용자 인증이라는 과정이 필요하다. 물론 모두에게 열려있는 리소스도 있지만, 대부분의 서비스는 그렇지 않다. 따라서 사용자 인증은 필수적인 과정이다.
>
> 사용자 인증방법에는 다음과같은 4가지 방법이 있다.
>
> 1. 지식 기반 인증 : ID/PW 와 같이 사용자가 알고있는 정보를 이용하여 인증한다.
> 2. 소유 기반 인증 : 토큰, 여권 등과 같은 사용자가 가지고 있는것을 통하여 인증한다.
> 3. 정적 생채 인증 : 홍채나 지문등을 이용하여 인증한다.
> 4. 동적 생채 인증 : 목소리, 행동패턴 등을 이용하여 인증한다.
>
> 이중 소지 기반 인증중 토큰에 대해 설명하려고 한다.
>
> 
>
> 토큰 기반 인증은 모던 웹서비스에서 많이 사용되는 인증방법이다. 이전에는 session인증을 많이 사용했는데 이 방법은 서버쪽에서 유저들의 정보는 기억하고 있는 방법입니다. 이 session을 유지하기위해 서버의 공간을 사용해야한다. 문제는 유저가 많아질 수록 서버의 무리가 된다.
>
> 토큰 기반 시스템은 stateless이다. 토큰을 발행하기 전 한번만 데이터베이스에서 유저의 유효성을 조회하고, 이후에는 토큰의 유효성만을 판단하고 요청에대한 응답만 해주면 된다.
>
> 정보를 서버에 저장하지 않고, 응답만 해주기 때문에 서버의 확장이나, 서버의 과부화문제에서부터 자유로울 수 있다.



## JWT

> JWT( Json Web Token ) 는 토큰 기반 인증 시스템의 구현체이다. JWT는 필요한 정보를 자체적으로 지니고 있다. 때문에 JWT를 이용하여 서비스를 구현할 때는, 토큰내에 담는 정보가 유출되어도 상관없는 정보여야 한다.
>
> 또한 JWT는 토큰 자체에 사용자 권한정보를 담아, 사용자 인증과 인가를 한번에 처리할 수 도 있다.



- JWT는 다음과 같은 상황에서 유용하게 사용된다.
  1. **회원인증**
  2. **정보 교류** : 두 개체 사이에서 안정성있게 정보를 교환하기 좋다. JWT는 특정 키로 해싱되어 있기 때문에 정보의 발신자와 조작여부를 검증할 수 있다.



- JWT 구조

  ```
  aaaaaaaaa.bbbbbbbbb.ccccccc
  --------- --------- ---------
   header    payload  signature
  ```

  **1. header**

  ```
  {
      "typ" : "JWT",
      "alg" : "HS256"
  }
  ```

  **2. payload**

  여기에 담는 key-value 쌍을 claim이라고 부른다.

  ```
  {
  	"key" : "value"   
  }
  ```

  **3.signature**

  서명은 헤더의 인코딩 값과, payload의 정보를 인코딩한 값을 합친뒤 서버가 가지고있는 비밀 키를 이용해 해쉬하여 생성한다.

  ```
  HMACSHA256(
    base64UrlEncode(header) + "." + base64UrlEncode(payload),
    '서버의 비밀 키')
  ```

  

- JWT는 토큰 자체에 정보가 있다는 부분이 큰 위험으로 작용될 수 있다. payload의 정보는 단순히 인코딩된 데이터로, 데이터를 누구나 볼 수 있다. 이러한 문제를 해결하기 위해 payload부분에 중요한 정보를 넣치 않거나 JWE( Json Web Encrytion )을 사용한다.



## Usage JWT

#### Create Token

```js
jwt.sign({data: 'walli'}, 'private_secret', { expiresIn: 60*60 });
```



#### Verify Token

```js
jwt.verify( token, 'private_secret', (err, decoded) => {
	if(err){
    // error handling logic
  }
  
  if(decoded){
    // next step
  }
})
```

